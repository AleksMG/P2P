<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC P2P Чат</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .disconnected {
            background-color: #ffebee;
            color: #c62828;
        }
        .connected {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .connecting {
            background-color: #fff8e1;
            color: #f57f17;
        }
        #messages {
            height: 300px;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            overflow-y: auto;
            background-color: #fafafa;
            border-radius: 5px;
        }
        .message {
            margin: 8px 0;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
        }
        .my-message {
            background-color: #e3f2fd;
            margin-left: auto;
            text-align: right;
        }
        .their-message {
            background-color: #f5f5f5;
            margin-right: auto;
        }
        input, textarea, button {
            padding: 10px;
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        button.secondary {
            background-color: #2196F3;
        }
        button.danger {
            background-color: #f44336;
        }
        .sdp-area {
            margin: 10px 0;
        }
        .sdp-area textarea {
            height: 100px;
            font-family: monospace;
            font-size: 12px;
        }
        .instructions {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-size: 14px;
            line-height: 1.5;
        }
        .step {
            margin: 8px 0;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebRTC P2P Чат</h1>
        
        <div class="instructions">
            <h3>Инструкция по подключению:</h3>
            <div class="step">1. На первом устройстве нажмите "Создать предложение"</div>
            <div class="step">2. Скопируйте SDP предложение из текстового поля</div>
            <div class="step">3. На втором устройстве вставьте SDP в поле "Чужое SDP" и нажмите "Принять предложение"</div>
            <div class="step">4. Скопируйте ответное SDP со второго устройства</div>
            <div class="step">5. На первом устройстве вставьте ответ в поле "Чужое SDP" и нажмите "Установить ответ"</div>
            <div class="step">6. Соединение установлено! Можно общаться</div>
        </div>
        
        <div id="status" class="status disconnected">Не подключен</div>
        
        <div id="messages"></div>
        
        <div class="sdp-area">
            <label>Ваше SDP предложение:</label>
            <textarea id="localSdp" readonly placeholder="Нажмите 'Создать предложение'"></textarea>
            <button id="createOfferBtn">Создать предложение</button>
            <button id="copySdpBtn" class="secondary">Скопировать SDP</button>
        </div>
        
        <div class="sdp-area">
            <label>Чужое SDP (вставьте сюда SDP другого устройства):</label>
            <textarea id="remoteSdp" placeholder="Вставьте SDP с другого устройства здесь"></textarea>
            <button id="setAnswerBtn">Установить ответ</button>
            <button id="acceptOfferBtn" class="secondary">Принять предложение</button>
        </div>
        
        <input type="text" id="messageInput" placeholder="Введите сообщение..." disabled>
        <button id="sendBtn" disabled>Отправить сообщение</button>
        <button id="disconnectBtn" class="danger" disabled>Отключиться</button>
    </div>

    <script>
        // Элементы интерфейса
        const statusDiv = document.getElementById('status');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const localSdpTextarea = document.getElementById('localSdp');
        const remoteSdpTextarea = document.getElementById('remoteSdp');
        const createOfferBtn = document.getElementById('createOfferBtn');
        const copySdpBtn = document.getElementById('copySdpBtn');
        const setAnswerBtn = document.getElementById('setAnswerBtn');
        const acceptOfferBtn = document.getElementById('acceptOfferBtn');
        const sendBtn = document.getElementById('sendBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        
        // WebRTC переменные
        let peerConnection = null;
        let dataChannel = null;
        
        // Конфигурация STUN серверов (бесплатные от Google)
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };
        
        // Установка статуса
        function setStatus(status, text) {
            statusDiv.className = 'status ' + status;
            statusDiv.textContent = text;
            console.log('Status:', status, text);
        }
        
        // Добавление сообщения в чат
        function addMessage(text, isMyMessage = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + (isMyMessage ? 'my-message' : 'their-message');
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // Создание PeerConnection
        function createPeerConnection() {
            try {
                peerConnection = new RTCPeerConnection(configuration);
                
                // Обработчик входящего канала данных
                peerConnection.ondatachannel = (event) => {
                    console.log('Получен канал данных');
                    dataChannel = event.channel;
                    setupDataChannel();
                };
                
                // Обработчики ICE кандидатов
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log('Новый ICE кандидат:', event.candidate);
                    }
                };
                
                peerConnection.onconnectionstatechange = () => {
                    console.log('Состояние соединения:', peerConnection.connectionState);
                    if (peerConnection.connectionState === 'connected') {
                        setStatus('connected', 'Подключен');
                        messageInput.disabled = false;
                        sendBtn.disabled = false;
                        disconnectBtn.disabled = false;
                    } else if (peerConnection.connectionState === 'disconnected') {
                        setStatus('disconnected', 'Отключен');
                        resetConnection();
                    }
                };
                
                return true;
            } catch (error) {
                console.error('Ошибка создания PeerConnection:', error);
                setStatus('disconnected', 'Ошибка: ' + error.message);
                return false;
            }
        }
        
        // Настройка канала данных
        function setupDataChannel() {
            dataChannel.onopen = () => {
                console.log('Канал данных открыт');
                setStatus('connected', 'Подключен');
                messageInput.disabled = false;
                sendBtn.disabled = false;
                disconnectBtn.disabled = false;
                addMessage('Соединение установлено! Можно общаться.');
            };
            
            dataChannel.onclose = () => {
                console.log('Канал данных закрыт');
                setStatus('disconnected', 'Соединение разорвано');
                resetConnection();
            };
            
            dataChannel.onmessage = (event) => {
                console.log('Получено сообщение:', event.data);
                addMessage(event.data, false);
            };
            
            dataChannel.onerror = (error) => {
                console.error('Ошибка канала данных:', error);
            };
        }
        
        // Создание предложения (offer)
        async function createOffer() {
            if (!createPeerConnection()) return;
            
            try {
                setStatus('connecting', 'Создание предложения...');
                
                // Создаем канал данных
                dataChannel = peerConnection.createDataChannel('chat');
                setupDataChannel();
                
                // Создаем предложение
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // Ждем установления local description
                await waitForIceGathering(peerConnection);
                
                // Показываем SDP предложение
                localSdpTextarea.value = JSON.stringify(peerConnection.localDescription);
                
                setStatus('connecting', 'Предложение создано. Скопируйте SDP и отправьте другому устройству.');
                
            } catch (error) {
                console.error('Ошибка создания предложения:', error);
                setStatus('disconnected', 'Ошибка: ' + error.message);
            }
        }
        
        // Принятие предложения (answer)
        async function acceptOffer() {
            if (!createPeerConnection()) return;
            
            try {
                const remoteOffer = JSON.parse(remoteSdpTextarea.value);
                if (!remoteOffer || remoteOffer.type !== 'offer') {
                    throw new Error('Неверное SDP предложение');
                }
                
                setStatus('connecting', 'Принятие предложения...');
                
                // Устанавливаем удаленное предложение
                await peerConnection.setRemoteDescription(remoteOffer);
                
                // Создаем ответ
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                // Ждем установления local description
                await waitForIceGathering(peerConnection);
                
                // Показываем SDP ответ
                localSdpTextarea.value = JSON.stringify(peerConnection.localDescription);
                
                setStatus('connecting', 'Ответ создан. Скопируйте SDP и отправьте обратно.');
                
            } catch (error) {
                console.error('Ошибка принятия предложения:', error);
                setStatus('disconnected', 'Ошибка: ' + error.message);
            }
        }
        
        // Установка ответа
        async function setAnswer() {
            try {
                const remoteAnswer = JSON.parse(remoteSdpTextarea.value);
                if (!remoteAnswer || remoteAnswer.type !== 'answer') {
                    throw new Error('Неверный SDP ответ');
                }
                
                setStatus('connecting', 'Установка ответа...');
                await peerConnection.setRemoteDescription(remoteAnswer);
                
            } catch (error) {
                console.error('Ошибка установки ответа:', error);
                setStatus('disconnected', 'Ошибка: ' + error.message);
            }
        }
        
        // Ожидание сбора ICE кандидатов
        function waitForIceGathering(pc) {
            return new Promise((resolve) => {
                if (pc.iceGatheringState === 'complete') {
                    resolve();
                } else {
                    const checkState = () => {
                        if (pc.iceGatheringState === 'complete') {
                            pc.removeEventListener('icegatheringstatechange', checkState);
                            resolve();
                        }
                    };
                    pc.addEventListener('icegatheringstatechange', checkState);
                }
            });
        }
        
        // Отправка сообщения
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message && dataChannel && dataChannel.readyState === 'open') {
                dataChannel.send(message);
                addMessage(message, true);
                messageInput.value = '';
            }
        }
        
        // Сброс соединения
        function resetConnection() {
            if (dataChannel) {
                dataChannel.close();
                dataChannel = null;
            }
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            messageInput.disabled = true;
            sendBtn.disabled = true;
            disconnectBtn.disabled = true;
            localSdpTextarea.value = '';
            remoteSdpTextarea.value = '';
        }
        
        // Копирование SDP в буфер обмена
        function copySdpToClipboard() {
            localSdpTextarea.select();
            document.execCommand('copy');
            alert('SDP скопировано в буфер обмена!');
        }
        
        // Обработчики событий
        createOfferBtn.addEventListener('click', createOffer);
        copySdpBtn.addEventListener('click', copySdpToClipboard);
        acceptOfferBtn.addEventListener('click', acceptOffer);
        setAnswerBtn.addEventListener('click', setAnswer);
        sendBtn.addEventListener('click', sendMessage);
        disconnectBtn.addEventListener('click', resetConnection);
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Информационное сообщение
        addMessage('Добро пожаловать в P2P чат! Следуйте инструкциям выше для подключения.');
    </script>
</body>
</html>
